<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal Sandbox for Learning</title>
    <style>
        /* Next Page Button Styling */
        .next-page-btn {
            background: linear-gradient(90deg, #5cd65c 0%, #6de06d 100%);
            color: #111;
            font-size: 1.25em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            padding: 16px 36px;
            margin: 32px auto 0 auto;
            box-shadow: 0 0 16px #5cd65ca0;
            transition: background 0.2s, color 0.2s, transform 0.1s;
            display: block;
        }

        .next-page-btn:hover {
            background: linear-gradient(90deg, #6de06d 0%, #5cd65c 100%);
            color: #000;
            transform: scale(1.05);
            box-shadow: 0 0 24px #5cd65c;
        }

        /* Basic styles for the terminal */
        body {
            font-family: 'Courier New', monospace;
            background-color: #1d1f21;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .task-list {
            width: 80%;
            max-width: 900px;
            background-color: #333;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
            color: #ffffff;
        }

        h3 {
            margin-bottom: 10px;
            font-size: 24px;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        li {
            padding: 5px;
            font-size: 18px;
        }

        .completed {
            text-decoration: line-through;
            color: #4CAF50;
        }

        .current-task {
            background-color: #4CAF50;
            color: #1d1f21;
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
            border: 2px solid #4CAF50;
        }

        #current-task {
            margin-top: 20px;
            font-size: 18px;
        }

        /* Basic styles for the terminal */
        .terminal {
            width: 80%;
            max-width: 900px;
            background-color: #2d2f33;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            height: 80vh;
        }

        .output {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 16px;
        }

        .input-line {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .prompt {
            color: #4CAF50;
            margin-right: 5px;
        }

        .command-input {
            background-color: #2d2f33;
            border: none;
            outline: none;
            color: #ffffff;
            font-size: 16px;
            width: 100%;
            padding: 5px;
        }

        .command-input:focus {
            border-color: #4CAF50;
        }

        /* Modal styles */
        .modal {
            display: block;
            position: fixed;
            z-index: 1000;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: auto;
            height: auto;
            background-color: transparent;
        }

        .modal-content {
            background-color: #333;
            padding: 30px;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            width: 400px;
            max-width: 90vw;
            text-align: center;
            color: #ffffff;
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.5);
            position: relative;
        }

        .modal-content h2 {
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .modal-content ul {
            list-style-type: disc;
            padding-left: 20px;
        }

        .modal-content li {
            margin-bottom: 10px;
        }

        #startTerminal {
            background-color: #4CAF50;
            color: #1d1f21;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 20px;
        }

        #startTerminal:hover {
            background-color: #45a049;
        }
    </style>
</head>

<body>

    <div class="task-list">
        <h3>Tasks</h3>
        <ul id="tasks">
            <!-- Task list will go here -->
        </ul>
        <p id="current-task"></p>
    </div>

    <div class="terminal">
        <div id="output" class="output"></div>
        <div class="input-line">
            <span class="prompt">$</span>
            <input type="text" id="command-input" class="command-input" autofocus />
        </div>
    </div>

    <!-- Next page button - shown after completing all tasks -->
    <button id="nextPageButton" class="btn next-page-btn" style="display:none;">Go to Next Page</button>

    <!-- Instructions Modal -->
    <div id="instructionsModal" class="modal">
        <div class="modal-content">
            <h2>Terminal Instructions</h2>
            <p><strong>Important:</strong></p>
            <ul style="text-align: left; margin: 20px 0;">
                <li>You must do the commands in order</li>
                <li>This is not a real terminal - you can only use the commands I am asking for</li>
                <li>If you have questions, refer to your "Terminal Commands Starter Pack" on Canvas</li>
            </ul>
            <button id="startTerminal" class="btn">Start Terminal</button>
        </div>
    </div>

    <!-- LS Quiz Modal -->
    <div id="lsQuizModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Side Quest</h2>
            <p id="lsQuizQuestion">Is "document.txt" a file or directory?</p>
            <div style="margin: 20px 0;">
                <button onclick="answerLsQuiz('file')" class="btn" style="margin: 0 10px;">File</button>
                <button onclick="answerLsQuiz('directory')" class="btn" style="margin: 0 10px;">Directory</button>
            </div>
            <p id="lsQuizResult" style="font-weight: bold; margin-top: 15px;"></p>
        </div>
    </div>

    
    <script src="../navigation.js"></script>
    <script>
        // Terminal game JavaScript
        const commandInput = document.getElementById('command-input');
        const outputArea = document.getElementById('output');
        const currentTaskElement = document.getElementById('current-task');
        const tasksElement = document.getElementById('tasks');
        const nextPageButton = document.getElementById('nextPageButton');
        const instructionsModal = document.getElementById('instructionsModal');
        const startTerminalButton = document.getElementById('startTerminal');

        // Modal functionality
        let terminalStarted = false;
        let lsQuizShown = false;

        // Show modal on page load and disable terminal input
        function initializePage() {
            instructionsModal.style.display = 'block';
            commandInput.disabled = true;
            commandInput.style.opacity = '0.5';
        }

        // Start terminal functionality
        function startTerminal() {
            instructionsModal.style.display = 'none';
            commandInput.disabled = false;
            commandInput.style.opacity = '1';
            commandInput.focus();
            terminalStarted = true;

            // Initialize tasks
            updateTaskList();
        }

        // Add event listener for start button
        startTerminalButton.addEventListener('click', startTerminal);

        // Initialize page on load
        window.addEventListener('DOMContentLoaded', initializePage);

        // List of simulated files in the current directory
        let files = ["document.txt", "code.js", "image.png"];  // No codingIsFun.txt initially
        let hiddenFiles = [".hidden_file"];  // Hidden files (not shown by default)
        let directories = []  // Simulated list of directories

        // Track current directory
        let currentDirectory = "/home/student";  // Start in the root directory

        // Task list with new tasks
        const tasks = [
            {
                name: "1. Create a file called codingIsFun.txt",
                command: "touch codingIsFun.txt",
                completed: false
            },
            {
                name: "2. Create a new directory called lies",
                command: "mkdir lies",
                completed: false
            },
            {
                name: "3. Move codingIsFun.txt into the lies directory",
                command: "mv codingIsFun.txt lies",
                completed: false
            },
            {
                name: "4. Rename the 'lies' directory to 'truths'",
                command: "mv lies truths",
                completed: false
            },
            {
                name: "5. Clear the screen using the 'clear' command",
                command: "clear",
                completed: false
            },
            {
                name: "6. Use the 'ls' command to see what's in this directory.",
                command: "ls",
                completed: false
            },
            {
                name: "7. Use the 'ls -a' command to see all files, including hidden ones.",
                command: "ls -a",
                completed: false
            },
            {
                name: "8. Hmmm, maybe the password is in one of those files... Maybe you could read those files...?",
                command: "less .hidden_file",
                completed: false
            }
        ];

        // Function to simulate terminal command output
        function printToOutput(text) {
            const outputElement = document.createElement('div');
            outputElement.textContent = text;
            outputArea.appendChild(outputElement);
            outputArea.scrollTop = outputArea.scrollHeight; // Scroll to bottom
        }

        // Function to update task list in the UI
        function updateTaskList() {
            tasksElement.innerHTML = '';
            const currentTask = tasks.find(t => !t.completed); // Find the first incomplete task

            tasks.forEach((task, index) => {
                const li = document.createElement('li');
                li.textContent = task.name;
                if (task.completed) {
                    li.classList.add('completed');
                } else if (task === currentTask) {
                    li.classList.add('current-task'); // Highlight the current task
                }
                tasksElement.appendChild(li);
            });
        }

        // Function to handle task completion
        function handleTaskCompletion(taskName) {
            const task = tasks.find(t => t.command === taskName);
            if (task && !task.completed) {
                task.completed = true;
                updateTaskList(); // Update the task list UI
                const nextTask = tasks.find(t => !t.completed);
                if (!nextTask) {
                    // All tasks completed - show completion message in the current task area
                    currentTaskElement.textContent = "You've completed all tasks! Check the terminal for the password...";
                    showQuiz();  // Show the quiz once all tasks are completed
                }
            }
        }

        // Handling command execution
        function handleCommand(command) {
            const commandParts = command.trim().split(" ");
            const mainCommand = commandParts[0].toLowerCase();
            const args = commandParts.slice(1);

            // Allow the 'clear' command to work at any time
            if (mainCommand === "clear") {
                outputArea.innerHTML = ''; // Clear the terminal screen
                handleTaskCompletion("clear");
                return;
            }

            // Only allow the user to proceed if the current task is completed
            const currentTask = tasks.find(t => !t.completed);
            // Allow 'cat' as alternative to 'less' for the hidden file task
            const isValidCommand = currentTask.command.includes(mainCommand) || 
                (currentTask.command.includes('less') && mainCommand === 'cat');
            if (currentTask && !isValidCommand) {
                printToOutput("You must complete the current task first before proceeding.");
                return;
            }

            switch (mainCommand) {
                case "touch":
                    // Simulate creating a file
                    if (args[0] === "codingIsFun.txt") {
                        files.push("codingIsFun.txt");
                        // printToOutput("File 'codingIsFun.txt' created.");
                        handleTaskCompletion("touch codingIsFun.txt");
                    }
                    break;
                case "ls":
                    if (args.length === 0) {
                        // Show both files and directories
                        printToOutput([...files, ...directories].join("\n"));

                        // Show quiz after first ls command
                        if (!lsQuizShown) {
                            lsQuizShown = true;
                            setTimeout(() => {
                                showLsQuiz();
                            }, 500);
                        } else {
                            handleTaskCompletion("ls");
                        }
                    } else if (args[0] === "-a") {
                        // Show both files, hidden files, and directories
                        printToOutput([...files, ...hiddenFiles, ...directories].join("\n"));
                        handleTaskCompletion("ls -a");
                    } else {
                        printToOutput(`ls: cannot access '${args[0]}': No such file or directory`);
                    }
                    break;
                case "pwd":
                    printToOutput(currentDirectory);  // Show current directory
                    handleTaskCompletion("pwd");
                    break;
                case "mkdir":
                    if (args[0] === "lies") {
                        if (!directories.includes("lies")) {  // Only create if "lies" doesn't exist
                            directories.push("lies");
                            // printToOutput("Directory 'lies' created.");
                            handleTaskCompletion("mkdir lies");
                        } else {
                            printToOutput("mkdir: cannot create directory 'lies': File exists");
                        }
                    }
                    break;
                case "mv":
                    if (args[1] === "lies") {
                        // Simulate moving codingIsFun.txt into lies directory
                        const fileIndex = files.indexOf("codingIsFun.txt");
                        if (fileIndex !== -1) {
                            files.splice(fileIndex, 1); // Remove the file from the current list
                            // printToOutput("codingIsFun.txt moved to lies");
                            handleTaskCompletion("mv codingIsFun.txt lies");
                        } else {
                            printToOutput("mv: cannot move 'codingIsFun.txt': No such file");
                        }
                    } else if (args[1] === "truths") {
                        // Simulate renaming the directory 'lies' to 'truths'
                        const dirIndex = directories.indexOf("lies");
                        if (dirIndex !== -1) {
                            directories[dirIndex] = "truths"; // Rename the directory
                            // printToOutput("Directory 'lies' renamed to 'truths'");
                            handleTaskCompletion("mv lies truths");
                        } else {
                            printToOutput("mv: cannot move 'lies': No such directory");
                        }
                    }
                    break;
                case "cd":
                    if (args[0] === "lies") {
                        if (directories.includes("lies")) {
                            currentDirectory = "/home/student/lies";  // Change to the "lies" directory
                            // printToOutput("Changed directory to /home/student/lies");
                            handleTaskCompletion("cd lies");
                        } else {
                            printToOutput("bash: cd: lies: No such directory");
                        }
                    } else if (args[0] === "truths") {
                        if (directories.includes("truths")) {
                            currentDirectory = "/home/student/truths";  // Change to the "truths" directory
                            // printToOutput("Changed directory to /home/student/truths");
                            handleTaskCompletion("cd truths");
                        } else {
                            printToOutput("bash: cd: truths: No such directory");
                        }
                    } else {
                        printToOutput(`bash: cd: ${args[0]}: No such file or directory`);
                    }
                    break;
                case "exit":
                    printToOutput("Exiting terminal... (This is just a simulation)");
                    break;
                case "less":
                case "cat":
                    if (args[0] === ".hidden_file") {
                        const password = getNextLevelPassword ? getNextLevelPassword() : null;
                        if (password) {
                            printToOutput("Password to the next level: " + password);
                        } else {
                            printToOutput("Password to the next level: [not set]");
                        }
                        handleTaskCompletion("less .hidden_file");
                        // Show the next page button after password is revealed
                        if (nextPageButton) {
                            nextPageButton.style.display = 'inline-block';
                        }
                    } else if (directories.includes(args[0])) {
                        // User tried to open a directory
                        printToOutput(`${args[0]} is a folder, not a file...`);
                    } else if (files.includes(args[0])) {
                        // User tried to open a non-hidden file
                        printToOutput("Not quite...");
                    } else {
                        printToOutput(`${mainCommand}: '${args[0]}': No such file`);
                    }
                    break;
                default:
                    printToOutput(`command not found: ${mainCommand}`);
                    break;
            }
        }
        // Handle command input and simulate terminal behavior
        commandInput.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                // Prevent commands before terminal is started
                if (!terminalStarted) {
                    return;
                }

                const command = commandInput.value.trim();
                if (command) {
                    printToOutput(`$ ${command}`); // Display the entered command
                    handleCommand(command); // Process the command
                }
                commandInput.value = ''; // Clear the input field
            }
        });

        // Show next page button after all tasks done
        function showQuiz() {
            nextPageButton.style.display = 'inline-block';
        }

        // Function to restart the terminal if the quiz is answered incorrectly
        function restartTerminal() {
            printToOutput("Restarting terminal... Please start over.");
            setTimeout(() => {
                outputArea.innerHTML = ''; // Clear the terminal output
                currentTaskElement.textContent = ""; // Clear the current task display
                tasks.forEach(task => task.completed = false); // Mark all tasks as incomplete

                // Reset quiz state
                lsQuizShown = false;
                currentQuizIndex = 0;
                quizCorrectAnswers = 0;

                // Reset file system state
                files = ["document.txt", "code.js", "image.png"];
                directories = [];

                updateTaskList();

                // Re-enable terminal input
                commandInput.disabled = false;
                commandInput.style.opacity = '1';
                commandInput.focus();
            }, 2000); // Wait 2 seconds before restarting
        }

        // LS Quiz functionality
        let lsQuizData = [
            { name: "document.txt", type: "file" },
            { name: "code.js", type: "file" },
            { name: "image.png", type: "file" },
            { name: "truths", type: "directory" }
        ];
        let currentQuizIndex = 0;
        let quizCorrectAnswers = 0;

        function showLsQuiz() {
            commandInput.disabled = true;
            commandInput.style.opacity = '0.5';
            currentQuizIndex = 0;
            quizCorrectAnswers = 0;
            showNextQuizQuestion();
        }

        function showNextQuizQuestion() {
            if (currentQuizIndex >= lsQuizData.length) {
                completeLsQuiz();
                return;
            }

            const item = lsQuizData[currentQuizIndex];
            const quizModal = document.getElementById('lsQuizModal');
            const questionElement = document.getElementById('lsQuizQuestion');

            questionElement.textContent = `Is "${item.name}" a file or directory?`;
            quizModal.style.display = 'block';
        }

        function answerLsQuiz(answer) {
            const item = lsQuizData[currentQuizIndex];
            const resultElement = document.getElementById('lsQuizResult');

            if (answer === item.type) {
                quizCorrectAnswers++;
                resultElement.textContent = "Correct!";
                resultElement.style.color = "#4CAF50";

                currentQuizIndex++;

                setTimeout(() => {
                    resultElement.textContent = "";
                    showNextQuizQuestion();
                }, 1500);
            } else {
                resultElement.textContent = `Incorrect. "${item.name}" is a ${item.type}. Restarting terminal...`;
                resultElement.style.color = "#ff4444";

                setTimeout(() => {
                    const quizModal = document.getElementById('lsQuizModal');
                    quizModal.style.display = 'none';
                    restartTerminal();
                }, 2000);
            }
        }

        function completeLsQuiz() {
            const quizModal = document.getElementById('lsQuizModal');
            quizModal.style.display = 'none';

            commandInput.disabled = false;
            commandInput.style.opacity = '1';
            commandInput.focus();

            printToOutput(`Quiz completed! You got ${quizCorrectAnswers} out of ${lsQuizData.length} correct.`);

            // Complete the ls task
            handleTaskCompletion("ls");
        }


        // Dynamically get the next level's password from constants.js
        function getNextLevelPassword() {
            if (typeof getLevelInfo === 'function') {
                // Use the full path as in constants.js
                const info = getLevelInfo('terminal/index.html');
                if (info && info.next) {
                    return info.next.password;
                }
            }
            return null;
        }

        // Attach click event for next page button
        nextPageButton.addEventListener('click', goToNextPage);
    </script>
</body>

</html>